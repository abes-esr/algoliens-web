{% extends "includes/base.html.twig" %}
{% block header %}
{% endblock %}

{% block body %}
    {{ include("includes/_breadcrumb.html.twig", {'page': 'stat'}) }}

    {% if iln.skipReasons | length > 0 %}
        <h1>Reprises à venir (<a href="{{ url("view_iln_reprises", {code: iln.code, secret: iln.secret}) }}">voir le
                détail</a>)</h1>
        <ul>
            {% for skipReason in iln.skipReasons %}
                <li>{{ skipReason.description }} : {{ skipReason.records|length }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <h1>Corrections hors algoliens</h1>
    <p>Depuis les premiers imports de notices dans cette interface pour {{ iln.label }}, des notices ont été corrigées
        sans être marquées comme corrigées dans cette interface et n'apparaissent plus ici. S'il ne nous est pas
        possible d'identifier les dates de correction de ces notices nous savons qu'elles ont disparues d'Algoliens et
        sont donc considérées comme corrigées (ces chiffres ne sont pas mis à jour en temps réel) : </p>
    <ul>
        {% for rcr in iln.rcrsWithRecordsFixedOutside %}
            <li>{{ rcr.label }} : {{ rcr.getNumberOfRecordsFixedOutside }}</li>
        {% endfor %}
    </ul>
    <h1>Historique</h1>
    {% for year, yeardetail in stats %}
        {% set corrected = 0 %}
        {% set reprise = 0 %}
        <h3>{{ year }}</h3>
        <table class="table">
            <tr>
                <th>Jour</th>
                <th>Notices corrigées</th>
                <th>Notices à reprendre document en main</th>
                <th>Total</th>
            </tr>
            {% for month, monthdetail in yeardetail %}
                {% for day, daydetail in monthdetail %}
                    {% set corrected = corrected + daydetail["1"] %}
                    {% set reprise = reprise + daydetail["2"] %}
                    <tr>
                        <td>{{ day }}/{{ month }}</td>
                        <td>{{ daydetail["1"] }}</td>
                        <td>{{ daydetail["2"] }}</td>
                        <th>{{ daydetail["1"]  + daydetail["2"] }}</th>
                    </tr>
                {% endfor %}
            {% endfor %}
            <tr>
                <th>Total</th>
                <th>{{ corrected }}</th>
                <th>{{ reprise }}</th>
                <th>{{ corrected + reprise }}</th>
            </tr>
        </table>
    {% endfor %}

    <h1>Information sur les chargements de notices</h1>
    <ul>
        {% for rcr in iln.rcrs %}
            <li>{{ rcr.code }} - {{ rcr.label }}
                {% if rcr.batchImports|length == 0 %}
                    : <i>aucun chargement</i>
                {% else %}
                    <ul>
                        {% for batch in rcr.batchImports %}
                            <li>{{ batch.typeLabel }} : {{ batch.startDate.format("d-m-Y à h:i:s") }} - <a
                                        href="{{ url("export_batch_import", {'code': iln.code, 'secret': iln.secret, 'id': batch.id}) }}">export
                                    les PPN des {{ batch.countRecords }} notices</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
{% endblock %}